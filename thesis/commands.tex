% !TEX root = semexp-thesis.tex

% include with relative paths
\usepackage{import}
\newcommand{\thimport}[2][.]{%
	\IfFileExists{#1/#2/../#2}{%
		\subimport{#1/#2}{../#2}%
	}{%
		\input{#1/#2}%
	}
}


% TEMPLATE PATCHES

% make pdf bookmark labels of chapters bold
\usepackage{bookmark}
\makeatletter
\bookmarksetup{
	open,
	addtohook={%
		\ifnum\bookmarkget{level}=0 %
			\if@mainmatter
				\bookmarksetup{bold}%
			\fi
		\fi
	},
}
\makeatother

% hide draft info
\makeatletter
\AtBeginDocument{
	\sbox{\swa@draftPageLine}{}
}
\makeatother

% patch date format
\usepackage[style=iso]{datetime2}

% convenient use of slashes with word wrapping (ported from ngerman)
\useshorthands*{"}
\defineshorthand{"/}{\slash\hspace{0pt}}

% labels in figure captions point to beginning of figure
\usepackage[all]{hypcap}

% declaration of authorship:
% - patch date format manually (datetime2 doesn't work here??)
\makeatletter
\expandafter\patchcmd{\endstatement}{\datedate}{\two@digits{\thedateyear}-\two@digits{\thedatemonth}-\two@digits{\thedateday}}{\typeout{patch 1 successful}}{\typeout{patch 1 failed}}
\makeatother
% - remove article before date
\makeatletter
\expandafter\patchcmd{\endstatement}{\@location, den }{\@location, }{\typeout{patch 2 successful}}{\typeout{patch 2 failed}}
\makeatother

% customize chapter preamble
\setkomafont{dictumtext}{\itshape\small}
\setkomafont{dictumauthor}{\normalfont}
\renewcommand*\dictumwidth{\linewidth}
\renewcommand*\dictumauthorformat[1]{--- #1\par}
\renewcommand*\dictumrule{}

% better asterism
\renewcommand{\asterism}{\smash{%
	\raisebox{-.5ex}{%
		\setlength{\tabcolsep}{.2pt}%
		*}}}

% shared list of figures and tables
% CREDITS: https://tex.stackexchange.com/a/120651/221054
\makeatletter
\renewcommand*{\ext@figure}{lot}
\let\c@figure\c@table
\let\ftype@figure\ftype@table
\let\listoffiguresandtables\listoftables
\renewcommand*\listtablename{List of Figures and Tables}
\makeatother


% COMMANDS

% landscape pages
\usepackage{afterpage}
\usepackage{pdflscape}
\usepackage{environ}
\newif\ifpreviewing
\ifdraft{%
	% just convenience for some PDF readers
	\previewingtrue  % Comment out this line to revert to standard behavior; restore landscape pages to A4
}{}
\makeatletter
\newbox\landscapefigure@saved@page
\def\afterpagebody#1{%
	\afterpage{
		\begin{landscape}
			\ifpreviewing%  % CREDITS: https://tex.stackexchange.com/a/719759/221054
				\AtBeginShipoutNext{%
					\setbox\landscapefigure@saved@page=\hbox{\resizebox{!}{0.707\height}{\box\AtBeginShipoutBox}}
					\setbox\AtBeginShipoutBox=\hbox{\box\landscapefigure@saved@page}
					\pdfpageheight=210mm
					\pdfpagewidth=148.5mm
					\hoffset=-0.293in
					\voffset=-0.293in
				}%
			\fi%
			\begin{figure}
				#1
			\end{figure}
		\end{landscape}
	}%
}
\makeatother
\NewEnviron{landscapefigure}{%
	\expandafter\afterpagebody\expandafter{\BODY}%
}
\let\oldfigure\figure
\let\endoldfigure\endfigure

\makeatletter
\newcommand{\DefaultFigureOptions}{}
\begingroup
	\edef\@tempa{\csname fps@figure\endcsname}%
	\global\let\DefaultFigureOptions\@tempa
\endgroup
\makeatother
\makeatother

% add new figure Z option for landscape page
\BeforeBeginEnvironment{document}{%
	\RenewDocumentEnvironment{figure}{ O{tbp} }{%
		% hack: should use \DefaultFigureOptions here, but expansion issue
		\IfStrEq{#1}{Z}{%
			\typeout{will use landscapefigure}%
			\landscapefigure
		}{%
			\typeout{will use oldfigure}%
			\oldfigure[#1]
		}%
	}{%
		\IfStrEq{#1}{Z}{%
			\endlandscapefigure
		}{%
			\endoldfigure
		}%
	}
}


% Semantic markup
\newcommand\bold[1]{\textbf{#1}}
\renewcommand\code[1]{%
	\texttt{#1}}
	%\textsf{#1}} % This looks more like Smalltalk
\newcommand\hardcode[1]{%
	\texttt{#1}}
\newcommand\name[1]{\textsc{#1}}

% example box
\newlength{\globalparindent}
\setlength{\globalparindent}{\parindent}
\usepackage[most]{tcolorbox}
\tcbset{
	smallbox/.style={
		%title	= {\refstepcounter{exa}example~\theexa.},
		before upper	= {\parindent=\globalparindent},
		},
	largebox/.style={
		%title	= {\refstepcounter{sum}summary~\theexa.},
		before upper	= {\parindent=\globalparindent},
		},
}
% todo refactor: automatically provide paragraph/section here
\newtcolorbox{smallbox}{
	smallbox,
	breakable,
	enhanced,
	before skip=\bigskipamount,
	after skip=\bigskipamount,
}
\newtcolorbox{largebox}{
	largebox,
	breakable,
	enhanced,
	before skip=2\bigskipamount,
	after skip=\bigskipamount,
}
\newenvironment{example}{%
	\smallbox
	\paragraph{Example.}
	\setlist[1]{leftmargin=2em}
}{
	\endsmallbox%
}
\newenvironment{summary}{%
	\largebox
	\section*{Summary}\vspace{-1em}
	\setlist[1]{leftmargin=2em}
}{%
	\endlargebox%
}
\newenvironment{genericbox}[1]{%
	\smallbox
	\paragraph{#1.}
	\setlist[1]{leftmargin=2em}
}{
	\endsmallbox%
}


% enumitem
% ... have them look nicer
\AtBeginDocument{%
	\setlist[description]{
		% copied over from swathesis
		noitemsep,font=\normalfont\scshape,leftmargin=\parindent,topsep=.5\baselineskip,partopsep=.5\baselineskip,
		listparindent=1em, % visible hanging indent for new paragraphs inside items
	}
}
% add noextralabelsep option (only insert regular space after label)
\makeatletter
\enitkv@key{}{noextralabelsep}[true]{%
	\enit@sepfrommarginfalse
	\enit@calcset\labelsep\tw@{\fontdimen2\font}
}
\makeatother


% Automatic reference labels (\cref)
\usepackage[nameinlink]{cleveref}


% absolute page counter
\usepackage{zref-abspage}


% biblatex: separator between multiple citations: change to semicolon only for \cites
\DeclareMultiCiteCommand{\cites}[\mkbibbrackets]{\cite}{\addsemicolon\space}


% circled numbers
\usepackage{circledsteps}


% Automatically insert placeholders for missing figures
\ifdraft{%
	\usepackage{commands/robustfigures}
}{}


% debug patching
%\tracingpatches
